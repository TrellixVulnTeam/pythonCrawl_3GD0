import base64
import re
import time
import os
import requests
import rsa
from django.conf import settings


def rsa_sign(message):
    cert_path = settings.CERT_ROOT
    filepath = os.path.join(cert_path, 'private_pkcs1.pem')
    with open(filepath, 'r') as f:
        privkey = rsa.PrivateKey.load_pkcs1(f.read().encode())
    crypto_email_text = rsa.sign(message.encode(), privkey, 'SHA-256')
    return crypto_email_text.hex().upper()


def cert_read():
    with open('rootca.cer', 'rb') as f:
        return f.read().hex().upper()


def jiupaipay(amount):
    stamp = time.time()

    url = 'https://jd.jiupaipay.com/paygateway/mpsGate/mpsTransaction'
    request_id = str(int(stamp))
    orderId = request_id + request_id[::-1]
    sign = 'amount={3}&charset=02&clientIP=2220&corpOrg=UPOP&goodsName=九派银联&merchantId=800001000020057&orderId={0}&payChannel=UPOP&requestId={1}&requestTime={2}&service=qrcodeSpdbPreOrder&signType=RSA256&terminalId=192.168.3.88&version=1.2'.format(
        orderId, request_id, request_id, amount)

    signed = rsa_sign(sign)
    # print('加签：', signed)
    # cert = cert_read()
    # print('证书：', cert)
    cert = '3082039B30820283A00302010202145EA52F1B628442613B3186D542E1CFFF640ABE59300D06092A864886F70D0101050500307F310B300906035504061302434E31273025060355040A0C1EE4B99DE6B4BEE5A4A9E4B88BE694AFE4BB98E69C89E99990E585ACE58FB8311E301C060355040B0C15E68A80E69CAFE983A8EFBC88E4BC81E4B89AEFBC893127302506035504030C1EE4B99DE6B4BEE5A4A9E4B88BE694AFE4BB98E69C89E99990E585ACE58FB8301E170D3138303733313037313934315A170D3139303733313037313934315A30818D3128302606092A864886F70D0109011619383130313237323030393931406B696E67706173732E636F6D3118301606035504030C0F383030303031303030303230303537311E301C060355040B0C15E68A80E69CAFE983A8EFBC88E4BC81E4B89AEFBC8931273025060355040A0C1EE4B99DE6B4BEE5A4A9E4B88BE694AFE4BB98E69C89E99990E585ACE58FB830819F300D06092A864886F70D010101050003818D0030818902818100A6614547FFAE7DC66248C60E1D6B63A3A568A6C1D5867BC34E1F76DC80C7F0F5C1918E6053D95B1BD281305B7FEF3128CF90EBF01492B90D62CD742CBF9A9C8FF7302B899CDC21B31322B6832F0C362CC5E03DD90E732D7502584DFEF3B9BD1F8207FDA93D728FE78C1A21F3478218E99ED70806DBB9606F83671B3568752E9F0203010001A3818330818030090603551D1304023000300B0603551D0F0404030205A030660603551D1F045F305D305BA059A0578655687474703A2F2F746F7063612E69747275732E636F6D2E636E2F7075626C69632F697472757363726C3F43413D35454245394444443041394636423243313638374444463444373330334445303630334234443730300D06092A864886F70D01010505000382010100AF12B5373698A63D75B97B8EBACF835ACC40A99160B741C66A43683205CF892E3E14718C43476643D6E33E2643FC2EF5BFE33F2EA96628FDDCA4B368C92E8293FF104D2E07E9DF4B68CDF1CEFD69A6BB6F70B5F2629ACA3434733500D6F82FF51D5394604493A435BE93D057741ADE6989B4BA870E5BE7F76837E3F0C73A923001F0D8AD126C6C9B74C9F314715A91939200787ABDF7A24B1AAFB3FFB98EF3090F22BBD02FF53665341A3FD63B8A9411BC20619BB87D6B40C665B8D41268476B8D8DD7B2E7FA55C3553018CADE637F6B6191BB06A8E916ED331D89EF81AFFD37A34968B14B497C2F561015128772CE2DDAA372ED75AA5AB5C2B27E69E8A05023'
    data = {
        'amount': amount,
        'charset': '02',
        'clientIP': '2220',
        'corpOrg': 'UPOP',
        'goodsName': '九派银联',
        'merchantId': '800001000020057',
        'orderId': orderId,
        'payChannel': 'UPOP',
        'requestId': request_id,
        'requestTime': request_id,
        'service': 'qrcodeSpdbPreOrder',
        'signType': 'RSA256',
        'terminalId': '192.168.3.88',
        'version': '1.2',
        'merchantCert': cert,
        'merchantSign': signed

    }
    headers = {

        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/69.0.3497.100 Safari/537.36'

    }
    # print(data)
    html = requests.post(url, headers=headers, data=data)
    # print(html.text)
    bankurl = re.search(r'bankUrl=(.*?)&', html.text).group(1)
    bankurl = base64.b64decode(bankurl)
    # print(str(bankurl, encoding='utf-8'))
    return str(bankurl, encoding='utf-8')
